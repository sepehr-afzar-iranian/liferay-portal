jobs:
    Build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v2
            - name: Set up JDK 8
              uses: actions/setup-java@v2
              with:
                  distribution: "adopt"
                  java-version: "8"
            - name: Cache Gradle packages # cache gradle and ant files for quick builds.
              uses: actions/cache@v2
              with:
                  key: ${{runner.os}}-gradle-caches
                  path: |
                      .m2
                      .gradle
                      /home/runner/.liferay
            - name: Set SAIN_DOCKER_VERSION env # this version comes from release-sain.properties
              run: >
                  echo "SAIN_DOCKER_VERSION="$(grep "sain.docker.release.version" release-sain.properties |
                  cut -d'=' -f2) >> $GITHUB_ENV
            - name: Echo SAIN_DOCKER_VERSION # we print it to be sure that is set correctly
              run: echo ${{env.SAIN_DOCKER_VERSION}}
            - name: Set SAIN_EXTENSION_NEXUS_URL env # this version comes from release-sain.properties
              run: >
                  echo "SAIN_EXTENSION_NEXUS_URL="$(grep "sain.extensions.nexus.url" release-sain.properties |
                  cut -d'=' -f2) >> $GITHUB_ENV
            - name: Set Release Info variables # these variables come from release-sain.properties
              run: |
                  echo release.info.date=$(grep "release.info.date" release-sain.properties | cut -d'=' -f2) >> release.$USER.properties
                  echo release.info.name=$(grep "release.info.name" release-sain.properties | cut -d'=' -f2) >> release.$USER.properties
                  echo release.info.version.display.name=$(grep "release.info.version.display.name" release-sain.properties | cut -d'=' -f2) SP ${{env.SAIN_DOCKER_VERSION}} >> release.$USER.properties
            - name: Echo SAIN_EXTENSION_NEXUS_URL # we print it to be sure that is set correctly
              run: echo ${{env.SAIN_EXTENSION_NEXUS_URL}}
            - name: Create backup from build.properties file
              run: mv build.properties build.properties.bak
            - name: Change Some Values in build.properties File
              run: >
                  cat build.properties.bak |
                  sed 's/#baseline.jar.report.level=off/baseline.jar.report.level=off/g ;
                  s/baseline.jar.report.level=persist/#baseline.jar.report.level=persist/g ;
                  s/jsp.precompile=on/jsp.precompile=off/g ;
                  s/org.gradle.daemon=true/org.gradle.daemon=false/g'
                  > build.properties
            - env:
                ANT_OPTS: "-Xmx2g"
              name: Ant Compile and Install Portal Snapshots
              run: ant compile install-portal-snapshots
            - env:
                ANT_OPTS: "-Xmx4g"
              name: Ant deploy all portal modules
              run: ant deploy
            - name: Move files to SAIN-Bundles # before create docker image, we should move those files to here.
              run: mkdir SAIN-bundles && mv /home/runner/work/liferay-portal/bundles/ SAIN-bundles/
            - name: Download modules
              run: >
                bash module-downloader.sh release-sain.properties
                ${{secrets.SAIN_REPO_URL}} ${{secrets.SAIN_FTP_USER}}
                ${{secrets.SAIN_FTP_PASS}} ${{env.SAIN_EXTENSION_NEXUS_URL}}
            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                password: ${{secrets.DOCKER_HUB_PASSWORD}}
                username: ${{secrets.DOCKER_HUB_USERNAME}}
            - name: Login to SAIN repository
              uses: docker/login-action@v1
              with:
                password: ${{secrets.SAIN_REPO_PASSWORD}}
                registry: ${{secrets.SAIN_REPO_URL}}
                username: ${{secrets.SAIN_REPO_USERNAME}}
            - id: buildx
              name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v1
            - id: docker_build_pre
              name: Build and push with version tag
              uses: docker/build-push-action@v2
              with:
                context: ./
                file: ./Dockerfile.pure
                push: true
                tags: ${{secrets.SAIN_REPO_URL}}/liferay/portal-737-ga8-no-marketplace:${{env.SAIN_DOCKER_VERSION}}
            - id: docker_build
              if: ${{github.event_name == 'release' && github.event.action == 'released'}}
              name: Build and push with latest tag (Runs ONLY in published releases)
              uses: docker/build-push-action@v2
              with:
                context: ./
                file: ./Dockerfile.pure
                push: true
                tags: |
                  ${{secrets.SAIN_REPO_URL}}/liferay/portal-737-ga8-no-marketplace:latest
                  ${{secrets.SAIN_REPO_URL}}/liferay/portal-737-ga8-no-marketplace:${{env.SAIN_DOCKER_VERSION}}
            - if: ${{github.event_name == 'release' && github.event.action == 'released'}}
              name: Build bundle artifact
              run: >
                curl -X POST ${{secrets.SAIN_GIT_BUNDLE_BUILDER_REPO_URL}}
                -F token=${{secrets.SAIN_GIT_BUNDLE_BUILDER_REPO_TOKEN}} -F ref=master
name: "Liferay CI Build Docker Image - No Marketplace"
on:
  push:
    branches:
      - 'sain-7.3.x-no-marketplace-build'